app-id: net.sourceforge.gMKVExtractGUI
runtime: org.kde.Platform # KDE is needed for MKVToolNix
runtime-version: "5.15"
sdk: org.kde.Sdk
command: gMKVExtractGUI
branch: stable
add-extensions:
  org.freedesktop.Sdk.Extension.mono6:
    directory: lib/mono6
    add-ld-path: .
    version: "20.08"
    autodownload: true
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/mono6
cleanup:
  - /include
  - /lib/*.a
  - /lib/*.la
  - /lib/cmake
  - /lib/pkgconfig
  - /share/man
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --filesystem=home
modules:
  - name: libgdiplus
    sources:
    - type: git
      url: https://github.com/mono/libgdiplus
      branch: "6.1"
  - name: boost
    buildsystem: simple
    build-commands:
      - mkdir -p /app/include
      - cp -R boost /app/include
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.77.0/source/boost_1_77_0.tar.bz2
        sha256: fc9f85fc030e233142908241af7a846e60630aa7388de9a5fafb1f3a26840854
  - name: cmark
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMARK_STATIC=OFF
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/commonmark/cmark/archive/refs/tags/0.30.2.tar.gz
        sha256: 6c7d2bcaea1433d977d8fed0b55b71c9d045a7cdf616e3cd2dce9007da753db3
  # TODO: build without gui
  - name: mkvtoolnix
    buildsystem: simple
    build-commands:
      - ./configure
        --enable-optimization
        --enable-debug
        --prefix=/app
        --with-docbook-xsl-root=/usr/share/xml/docbook/xml/xsl-stylesheets
        --disable-update-check
      - rake
      - rake install
    sources:
      - type: archive
        url: https://mkvtoolnix.download/sources/mkvtoolnix-64.0.0.tar.xz
        sha256: 843ea623f21ae2407f8f42839c41a22abf116bdd509e87d875bdc737703ab953

  - name: gMKVExtractGUI
    buildsystem: simple
    build-commands:
      - install -Dm755 gMKVExtractGUI.exe /app/gmkvextractgui/gMKVExtractGUI.exe
      - install -Dm644 gMKVToolNix.dll /app/gmkvextractgui/gMKVToolNix.dll
      - install -Dm644 Newtonsoft.Json.dll /app/gmkvextractgui/Newtonsoft.Json.dll
      - ln -s "/app/bin/mkvextract" "/app/gmkvextractgui/mkvextract"
      - ln -s "/app/bin/mkvinfo" "/app/gmkvextractgui/mkvinfo"
      - ln -s "/app/bin/mkvmerge" "/app/gmkvextractgui/mkvmerge"
      - ln -s "/app/bin/mkvpropedit" "/app/gmkvextractgui/mkvpropedit"
      - install -Dm755 launch.sh /app/bin/gMKVExtractGUI
      - install -Dm644 net.sourceforge.gMKVExtractGUI.appdata.xml /app/share/appdata/net.sourceforge.gMKVExtractGUI.appdata.xml
      - install -Dm644 net.sourceforge.gMKVExtractGUI.desktop /app/share/applications/net.sourceforge.gMKVExtractGUI.desktop
      - install -Dm644 net.sourceforge.gMKVExtractGUI.png /app/share/icons/hicolor/256x256/apps/net.sourceforge.gMKVExtractGUI.png
    sources:
      - type: archive
        path: gMKVExtractGUI.v2.5.2.tar.xz
      - type: script
        dest-filename: launch.sh
        commands:
          - /app/lib/mono6/bin/mono /app/gmkvextractgui/gMKVExtractGUI.exe "$@"
      - type: file
        path: net.sourceforge.gMKVExtractGUI.appdata.xml
      - type: file
        path: net.sourceforge.gMKVExtractGUI.desktop
      - type: file
        path: net.sourceforge.gMKVExtractGUI.png
